# Advanced data retrieval

```{r}
# Use tidycensus to extract tract-level data from Colorado and Utah on population (P001001) and rural population (P002005) based on 2000 decennial census; assigns data to object named "population_rural_CO_UT"
population_rural_CO_UT<-get_decennial(geography = "tract",
                                      state=c("CO", "UT"),
                                      variables = c("P001001", "P002005"),
                                      output="wide",
                                      year = 2000) 
```


## Retrieving data from multiple census years

```{r, error=TRUE}
# Attempts to extract state level data (for all US states) on population (P001001) and rural population (P002005) based on 2000 decennial census and 2010 decennial census, and assign to new object named "population_rural_2000_2010"
population_rural_2000_2010<-get_decennial(geography = "state", 
                                         variables = c("P001001", "P002005"),
                                         output="wide",
                                         year = c(2000,2010)) 
```


### Retrieving different census year datasets and placing them as separate elements in a list

```{r, message=F, warning=F}

# Creates function that takes a given year as an input, and uses tidycensus to extract a state-level dataset of population (P001001) and rural population (P002005) for the specified year; the output dataset also includes new columns containing the state's rural population as a percentage of the overall population ("rural_pct") and the year to which the data corresponds ("year"); the function is assigned to a new object named "census_query"

census_query<-function(desired_year){
  get_decennial(geography = "state", 
                  variables = c("P001001", "P002005"),
                  output="wide",
                  year=desired_year) %>% 
    mutate(rural_pct=(P002005/P001001)*100) %>% 
    mutate(year=desired_year)
}

# Test the "census_query" object for the year 2000
census_query(2000)

```

```{r}
# Creates a new vector, assigned to an object named "my_years", containing the years for which we want to extract data
my_years<-c(2000,2010)

# Applies the "census_query" function to the inputs specified by the "my_years" vector, and deposits the two resulting datasets (one from 2000 and the other from 2010) as distinct elements in a list assigned to an object named population_rural_2000_2010_list
population_rural_2000_2010_list<-map(.x=my_years, .f=census_query)

# Prints the contents of "population_rural_2000_2010_list"
population_rural_2000_2010_list

# Extracts the first list element (the 2000 dataset) from the list using its index
population_rural_2000_2010_list %>% pluck(1)

# Names the list elements based on the input years (i.e. the years in "my_years")
names(population_rural_2000_2010_list)<-my_years

# prints "population_rural_2000_2010_list"; notice the list elements are now named after the years to which they correspond 
population_rural_2000_2010_list

# Extracts the 2010 dataset from "population_rural_2000_2010_list" using its newly assigned name
population_rural_2000_2010_list %>% pluck("2010")

# Note that even if a list element is named, you can still extract it using its index, rather than its name
population_rural_2000_2010_list %>% pluck(2)

```

### Retrieving different census year datasets and placing them in a single data frame

```{r, message=F, warning=F}
# Applies the "census_query" function to the inputs specified by the "my_years" vector, and deposits the resulting census datasets (one from 2000 and the other from 2010) into a single data frame assigned to an object named "population_rural_2000_2010_df"
population_rural_2000_2010_df<-map_dfr(.x=my_years, .f=census_query) %>% arrange(GEOID)

# prints the first few records of "population_rural_2000_2010_df" 
population_rural_2000_2010_df
```

## Retrieving microgeography data from multiple states

```{r, error=TRUE}
population_rural_CO_UT<-get_decennial(geography = "tract", 
                                      state=c("CO","UT"),
                                      variables = c("P001001", "P002005"),
                                      output="wide",
                                      year=2000) %>% 
                        mutate(rural_pct=(P002005/P001001)*100) %>% 
                        mutate(year=my_years)                 

```

### List

```{r}
my_states<-c("CO", "UT")
population_rural_CO_UT<-function(desired_state){
  get_decennial(geography = "tract", 
                state=desired_state,
                variables = c("P001001", "P002005"),
                output="wide",
                year=2010) %>% 
    mutate(rural_pct=(P002005/P001001)*100) %>% 
    mutate(Year=2010) %>% 
    mutate(STATE=desired_state)
}


population_rural_CO_UT_list<-map(.x=my_states, .f=population_rural_CO_UT)
population_rural_CO_UT_list
population_rural_CO_UT_list %>% pluck(1)

names(population_rural_CO_UT_list)<-my_states

population_rural_CO_UT_list

population_rural_CO_UT_list %>% pluck("UT")
```

### df 

```{r}
population_rural_CO_UT_df<-map_dfr(.x=my_states, .f=population_rural_CO_UT)
population_rural_CO_UT_df
```

## Retrieving microgeography data from multiple states AND multiple years  

### List

```{r}
my_states<-c("CO", "CO", "UT", "UT")
my_years<-c(2000, 2010, 2000, 2010)

population_rural_CO_UT_2000_2010<-function(desired_state, desired_year){
  get_decennial(geography = "tract", 
                state=desired_state,
                variables = c("P001001", "P002005"),
                output="wide",
                year=desired_year) %>% 
    mutate(rural_pct=(P002005/P001001)*100) %>% 
    mutate(YEAR=desired_year) %>% 
    mutate(STATE=desired_state)
}

population_rural_CO_UT_2000_2010_list<-map2(.x=my_states, .y=my_years, .f=population_rural_CO_UT_2000_2010)

population_rural_CO_UT_2000_2010_list

population_rural_CO_UT_2000_2010_list %>% pluck(2)

name_vector<-paste0(my_states, "_", my_years)

names(population_rural_CO_UT_2000_2010_list)<-name_vector

population_rural_CO_UT_2000_2010_list

population_rural_CO_UT_2000_2010_list %>% pluck("CO_2010")
```

### df

```{r}
population_rural_CO_UT_2000_2010_df<-map2_dfr(.x=my_states, .y=my_years, .f=population_rural_CO_UT_2000_2010)
```

```{r}
population_rural_CO_UT_2000_2010_df
```




[https://mattherman.info/blog/tidycensus-mult-year/](https://mattherman.info/blog/tidycensus-mult-year/)





median age by county colorado
vis and map

functions and iteration

advanced retrieval

temporal dynamics

